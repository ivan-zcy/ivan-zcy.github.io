<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  

  <!--Author-->
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="Linux复习归纳10-tcpdump和Wireshark下篇"/>
  
  <!--Open Graph Description-->
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="Zcy"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

    <meta name="baidu-site-verification" content="8vgn54BtUC" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- 百度统计 -->
    <script>
	var _hmt = _hmt || [];
	(function() {
  	var hm = document.createElement("script");
  	hm.src = "https://hm.baidu.com/hm.js?c0451e16533956173997b85f7a8de666";
  	var s = document.getElementsByTagName("script")[0]; 
  	s.parentNode.insertBefore(hm, s);
	})();
    </script>
  <!-- Title -->
  
  <title>Linux复习归纳10-tcpdump和Wireshark下篇 - Zcy</title>


  <link rel="shortcut icon" href="/favicon.ico">
    <!--font-awesome-->
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/animate.css">
    <link rel="stylesheet" href="/css/thplayer.css">
  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">
    <!--顶部上方进度条-->
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="/css/pace-theme-flash.css" rel="stylesheet">
    <style>
        .pace .pace-progress {
            background: #cccccc; /*进度条颜色*/
            height: 3px;
        }
        .pace .pace-progress-inner {
            box-shadow: 0 0 10px #cccccc, 0 0 5px #cccccc; /*阴影颜色*/
        }
        .pace .pace-activity {
            border-top-color: #cccccc;    /*上边框颜色*/
            border-left-color: #cccccc;    /*左边框颜色*/
        }
    </style>


    <!--小火箭-->
    <link rel="stylesheet" type="text/css" href="/css/rocketTop.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/rocketTop.js"></script>

</head>

<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="/img/timg.jpg" alt="Zcy" height="60">
        
      </a>
    </div>
    <a class="header-name" href="/">
            <span>Zcy</span>
            的小屋
        </a>
    <!-- navbar -->
    <nav class="navbar">
      <!--  nav links -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  <i class="fa fa-home "></i>
                
                小屋
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  <i class="fa fa-archive "></i>
                
                点滴
              </a>
            </li>
          
            <li>
              <a href="/tags">
                
                  <i class="fa fa-archive "></i>
                
                标签
              </a>
            </li>
          
            <li>
              <a href="/project">
                
                  <i class="fa fa-folder-open "></i>
                
                项目
              </a>
            </li>
          
            <li>
              <a href="/photo">
                
                  <i class="fa fa-photo "></i>
                
                相册
              </a>
            </li>
          
            <li>
              <a href="/guestbook">
                
                  <i class="fa fa-edit "></i>
                
                留言
              </a>
            </li>
          
            <li>
              <a href="/game">
                
                  <i class="fa fa-gamepad "></i>
                
                游戏
              </a>
            </li>
          
            <li>
              <a href="/aboutMe/index.html">
                
                  <i class="fa fa-user "></i>
                
                关于我
              </a>
            </li>
          
            <li>
              <a href="/friendly">
                
                  <i class="fa fa-bicycle "></i>
                
                链接
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
    <div class="post">
        <!-- Post Content -->
        <div class="container">
            <article>
                <!-- Title date & tags -->
                <div class="post-header">
                    <h1 class="entry-title">
                        Linux复习归纳10-tcpdump和Wireshark下篇
                        
                    </h1>

                </div>


                <div style="text-align:center;color: #ccc;">
    <span class="post-time" >
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <span class="post-count">1.9k字</span>
      </span>
    </span>

                    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">7分</span>
      </span>
    </span>
                </div>

                <p class="a-posted-on" style="color: #ccc;">
                    2019-06-02
                </p>
                <!-- Post Main Content -->
                <div class="entry-content">
                    <p><img src="/2019/06/02/Linux复习归纳10-tcpdump和Wireshark下篇/title10.jpg" alt="title10"></p>
<a id="more"></a>
<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><p>Linux复习归纳10～</p>
<h2 id="tcpdump和Wirshark"><a href="#tcpdump和Wirshark" class="headerlink" title="tcpdump和Wirshark"></a>tcpdump和Wirshark</h2><h4 id="抓到的报文格式"><a href="#抓到的报文格式" class="headerlink" title="抓到的报文格式"></a>抓到的报文格式</h4><p><img src="/2019/06/02/Linux复习归纳10-tcpdump和Wireshark下篇/Users/mac/zcy/Blog/source/_posts/Linux%E5%A4%8D%E4%B9%A0%E5%BD%92%E7%BA%B310-tcpdump%E5%92%8CWireshark%E4%B8%8B%E7%AF%87/2.png" alt="2"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一列：时间戳,分别代表时、分、秒、微秒</span><br><span class="line">第二列：网际网路协议名称</span><br><span class="line">第三列：报文发送方的网际网路协议地址和端口</span><br><span class="line">第四列：&gt; (用于指向接收方)</span><br><span class="line">第五列：报文接收方的网际网路协议地址和端口(有时不是端口而是协议名比如http)</span><br><span class="line">第六列：:</span><br><span class="line">第七列：Flags标识，可能取值是[S.] [.] [P.] [F.]等(标识有SYN表示建立连接,FIN表示关闭连接,ACK表示相应,PSH表示有数据传输，RST表示连接重置，其中ACK可能与SYN、FIN等同时使用，SYN与FIN不可能同时为1，RST一般在FIN后才会出现1的情况，PSH表示有真正的tcp数据包内容被传递)</span><br><span class="line">之后列是tcp协议报文头的一些变量值，比如seq为请求同步的序列号，ack是已同步的序列号,win是当前可用窗口大小，length是tcp协议报文体的长度</span><br></pre></td></tr></table></figure>
<h4 id="tcpdump抓取网站网络数据实例"><a href="#tcpdump抓取网站网络数据实例" class="headerlink" title="tcpdump抓取网站网络数据实例"></a>tcpdump抓取网站网络数据实例</h4><ol>
<li>通过tcpdump截取主机<a href="http://www.baidu.com发送与接收的所有数据包" target="_blank" rel="noopener">www.baidu.com发送与接收的所有数据包</a></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump -i en0 host www.baidu.com</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>访问这个网站</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget www.baidu.com</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>此时tcpdump会出现以下包信息：</li>
</ol>
<p><img src="/2019/06/02/Linux复习归纳10-tcpdump和Wireshark下篇/Users/mac/zcy/Blog/source/_posts/Linux%E5%A4%8D%E4%B9%A0%E5%BD%92%E7%BA%B310-tcpdump%E5%92%8CWireshark%E4%B8%8B%E7%AF%87/1.png" alt="1"></p>
<p>​    我们发现三次握手中第三次时ACK为1，其实这是相对值，我们可以通过下面命令获取ACK的绝对值：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump -S -i en0 host www.baidu.com</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>若想要看到详细的http报文，可以通过下面命令：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump -A -i en0 host www.baidu.com</span><br></pre></td></tr></table></figure>
<h3 id="关于Wireshark"><a href="#关于Wireshark" class="headerlink" title="关于Wireshark"></a>关于Wireshark</h3><h4 id="关于Wireshark-1"><a href="#关于Wireshark-1" class="headerlink" title="关于Wireshark"></a>关于Wireshark</h4><p>​    Wireshark用于捕获机器上某块网卡的网络包（如果一个机器有多个网卡，可以指定其中一个网卡）。出于安全考虑，它不可以修改封包的内容或者发送封包。它也不能解密https（也就是所看不懂https中的内容，如果只处理http和https，可以考虑Fiddler）</p>
<h4 id="用处"><a href="#用处" class="headerlink" title="用处"></a>用处</h4><ol>
<li>抓包来分析测试自己的软件</li>
<li>用wireshark来检查网络问题</li>
<li>socket编程会用wireshark来调试</li>
</ol>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><ol>
<li>先选定需要捕获哪个网卡的网络包</li>
<li>主界面中从上往下依次是显示过滤器（用于过滤）、封包列表（显示捕获到的封包）、封包详细信息、16进制数据、地址栏（杂项）</li>
<li>右键想要查找的报文-&gt;跟踪流-&gt;tcp流即可</li>
</ol>
<h4 id="关于过滤器"><a href="#关于过滤器" class="headerlink" title="关于过滤器"></a>关于过滤器</h4><p>​    封包列表中会有大量的冗余无用信息，我们可以利用过滤器将其过滤掉。过滤器有两种，一种是显示过滤器（主界面最上面），另一种是捕获过滤器（设置捕获的数据类型，在捕获-&gt;捕获过滤器中设置）</p>
<p>​    过滤分为协议过滤（比如tcp、udp等）、ip过滤（比如ip.src==192.168.1.30代表显示原地址为192.168.1.30的数据报，ip.dst==192.168.2.31代表显示目标地址为192.168.2.31的数据包）、端口过滤（比如tcp.port==80代表显示端口号为80的，tcp.srcport==80代表源端口号为80的）、http模式过滤（比如http.request.method==”GET”代表只显示get方法），它们可以通过逻辑运算符连接（AND/OR）</p>
<h4 id="关于封包详细信息"><a href="#关于封包详细信息" class="headerlink" title="关于封包详细信息"></a>关于封包详细信息</h4><p>​    封包详细信息最多有5行，分别是Frame（物理层的数据帧概况）、Ethernet II（数据链路层以太网帧头部信息）、Internet Protocol Version 4（网络层IP包头部信息）、Transmission Control Protocol（传输层的数据段头部信息，此处是TCP）、Hypertext Transfer Protocol（应用层的信息，此处是HTTP协议）</p>
<p>​    其中对于传输层的详细信息来说，source port为源端口，destination port为目的端口，sequence number为序列号，acknowledgment. number为确认号，Header Length为报头长度，flags为标志位，window size value 为窗口大小，checksum为校验和，</p>
<h3 id="关于三次握手四次挥手"><a href="#关于三次握手四次挥手" class="headerlink" title="关于三次握手四次挥手"></a>关于三次握手四次挥手</h3><h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><ol>
<li>由客户端向服务器端发起TCP连接请求（同步序列编号SYN置为1，发送序号Seq为一个随机数（避免黑客通过伪装发送数据报）假设为X）</li>
<li>服务器端接收到连接请求（同步序列编号SYN置为1，并将确认序号ACK置为X+1，然后生成一个随机数Y（与X同理）作为发送序号Seq）</li>
<li>客户端对接收到的确认进行确认（将确认序号ACK置为Y+1，然后将发送序号Seq置为X+1）</li>
</ol>
<h4 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h4><p>​    双方完成数据传输后就需要断开连接，由于tcp属于全双工通道，因此可以在一条tcp连接上相互传输数据，因此在一方失去发送数据的能力时，存在一个半关闭的状态，使得其还可以接收数据。这时就需要四次挥手</p>
<ol>
<li>A向B发起断开连接请求（关闭序列编号FIN置为1，发送序号Seq假设为X），A进入FIN-WAIT-1状态；(第一次挥手)</li>
<li>B收到断开请求后向A发送确认（ACK置为1，发送序号Seq假设为Y，然后ack为X+1），然后进入CLOSE-WAIT状态；(第二次挥手)</li>
<li>A收到B的确认后，进入FIN-WAIT-2状态（半关闭状态）</li>
<li>过一段时间后，B向A发出断开连接请求（ACK置为1，关闭序列编号FIN置为1，发送序号Seq假设为Z，然后ack为X+1），然后进入LAST-ACK状态 (第三次挥手)</li>
<li>A接收到请求后发送确认（ACK置为1，发送序号Seq为X+1，然后ack为Z+1），进入TIME-WAIT状态，等待2MSL之后进入CLOSED状态 (第四次挥手)</li>
<li>B收到确认后进入CLOSED状态</li>
</ol>
<h4 id="问题一：为什么至少三次挥手"><a href="#问题一：为什么至少三次挥手" class="headerlink" title="问题一：为什么至少三次挥手"></a>问题一：为什么至少三次挥手</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. tcp是一个全双工通道，它建立连接的基础是双方都需要确保自己具有接收对方信息和给对方发送信息的能力，而三次则是理论上的最小值(第一次服务端能确认自己有接收能力，客户端有发送能力；第二次客户端能确认客户端和服务端都有接收和发送能力；第三次服务端能确定服务端和客户端都有接收和发送能力)</span><br><span class="line">2. 客户端向服务端发送一个请求，服务端收到后会返回一个确认报文。而此时客户端断开连接，服务端却单方面认为连接成功，而等待客户端的动作，从而导致服务端开销增大</span><br></pre></td></tr></table></figure>
<h4 id="问题二：第四次挥手为什么需要等待2MSL"><a href="#问题二：第四次挥手为什么需要等待2MSL" class="headerlink" title="问题二：第四次挥手为什么需要等待2MSL"></a>问题二：第四次挥手为什么需要等待2MSL</h4><ol>
<li>确保A最后发送的确认能够到达B(如果B收不到会超时重传FIN给A)，至于2MSL能够保证A游足够的时间去再次发送确认</li>
<li>如果没有等待2MSL直接到close状态。那么当A再次向B发起连接请求，若该请求报文的包比上一次连接的最后一次挥手确认的包更早的到达B。那么B会以为这个连接为失效连接。等待2MSL可以尽量避免这种情况的出现</li>
</ol>
<h4 id="问题三：为什么断开连接请求报文只有三个，而不是4个？"><a href="#问题三：为什么断开连接请求报文只有三个，而不是4个？" class="headerlink" title="问题三：为什么断开连接请求报文只有三个，而不是4个？"></a>问题三：为什么断开连接请求报文只有三个，而不是4个？</h4><p>​    在tcp连接过程中，确认的发送有一个延时，一端在发送确认的时候将等待一段时间。如果在这段时间内自己也有数据要发送，那就跟确认一起发送，如果没有则单独发送。（服务端先断开连接，客户端在确认的时延内有也有请求断开连接需要发送，于是和确认一起发送，因此只有三个数据报）</p>

                </div>
            </article>
        </div>
        <br>
        <div style="text-align:center;color: #ccc;font-size:14px;">
            <br>
            <br>
            <a href="http://www.ivan-zcy.top" style="color: #99FFFF;font-size:18px;">转载请注明出处！！！</a>
            <br>
            <br>
            如果有写的不对或者不全面的地方 可通过主页的联系方式进行指正，谢谢!
        </div>
        <br>
        <!-- Pre or Next -->
        
        <div class="container" >
            <ul class="pager">
                
                
                <li class="next">
                    <a href="/2019/05/23/Linux复习与归纳9-tcpdump上篇/" rel="prev">上一篇</a>
                </li>
                
            </ul>
        </div>
        　　　　<!-- Comments -->
        <div class="container">
            
<section id="comment">
  <!-- <h1 class="title">Comments</h1> -->

  
</section>


        </div>
        
        　　　　
    </div>
</div>


  <div id="Thplayer"></div>
  <script type="application/javascript" src="/js/thplayer.min.js"></script>
  <script>
      $("#Thplayer").thplayer({
          title: "遇见",
          author: "孙燕姿",
          cover: "/img/yj.jpg",
          music: "http://www.ytmp3.cn/down/37418.mp3"
      });
  </script>

  <!-- Footer -->
  <!-- top -->

<!-- Footer -->
<footer class="site-info">
    <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  本站总访问量<span id="busuanzi_value_site_pv"></span>次
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
    <p>
        <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
    </p>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("09/28/2018 08:00:00");//此处修改你的建站时间或者网站上线时间
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
          document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
      }
      setInterval("createtime()",250);
  </script>
  <p>
    <span>Zcy &copy; 2019</span>
      
    <span class="split">|</span>
    <span>Zcy</span>
    
  </p>
</footer>


  <!--小火箭-->
  <div id="shape">
    <div class="shapeColor">
      <div class="shapeFly">
      </div>
    </div>
  </div>

  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>


  <script>
      (function(){

          function _scroll(){
              var acticles = $('.article > .container');
              var height = window.innerHeight || document.body.offsetHeight;
              acticles.each(function () {
                  var top = this.getBoundingClientRect().top;
                  if(top < height+1){
                      if(!$(this).hasClass('animated')) {
                          $(this).addClass('slideInRight');
                          $(this).addClass('animated');
                      }
                  }
              })

              $(window).scroll(function () {
                  acticles.each(function () {
                      var top = this.getBoundingClientRect().top;
                      if(top < height+1){
                          if(!$(this).hasClass('animated')) {
                              $(this).addClass('slideInRight');
                              $(this).addClass('animated');
                          }
                      }
                  })
              })
          }


          var bp = document.createElement('script');
          var curProtocol = window.location.protocol.split(':')[0];
          if (curProtocol === 'https') {
              bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
          }
          else {
              bp.src = 'http://push.zhanzhang.baidu.com/push.js';
          }
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(bp, s);
          _scroll();
      })();
  </script>
  <script type="text/javascript"
          color="0,0,0" opacity='0.5' zIndex="-2" count="35" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/clicklove.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"left","width":70,"height":140},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
